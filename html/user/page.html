<% layout("/layouts/main", {
	title: $.targetUser.displayName,
	scripts: ["user/page", "signature"],
	styles: ["signature"],
	meta: {
		userID: $.targetUser.id,
		lastLogin: $.targetUser.auth.lastLogin
	}
}) %>
<%
	const missingDetails = $.targetUser.missingDetails
	const blockAccess = Config.passkeyRequired && $.user.auth.keys.length == 0
%>

<h1 id="user-title">
	<i>person</i>
	<%= $.targetUser.displayName %>
</h1>
<% if($.targetUser.org) { %>
	<p>(<%= Config.orgs[$.targetUser.org].name %>)</p>
<% } %>
<div class="button-row">
	<% if($.user.id == $.targetUser.id) { %>
		<button id="logout-button" api="logout">
			<i>logout</i>
			Wyloguj
		</button>
	<% } %>
	<% if($.user.hasPermission($.targetUser.PERMISSIONS.DELETE)) { %>
		<button id="delete-user-button" class="dangerous" api="user/[userID]/delete">
			<i>delete</i>
			Usuń użytkownika
		</button>
		<dialog id="delete-user-dialog">
			<h1>Trwale usunąć użytkownika <%= $.targetUser.displayName %>?</h1>
			<p>Użytkownik i wszystkie związane z nim dane zostaną trwale usunięte.</p>
			<div class="button-row">
				<button>
					<i>arrow_back</i>
					Anuluj
				</button>
				<button class="dangerous" command>
					<i>delete</i>
					Usuń
				</button>
			</div>
		</dialog>
	<% } %>
	<% if($.user.hasPermission($.targetUser.PERMISSIONS.GENERATE_ACCESS_CODE)) { %>
		<button id="generate-access-code-button" opens-dialog="/users/<%= $.targetUser.id %>/accessCode">
			<i>password</i>
			Wygeneruj kod rejestracyjny
		</button>
	<% } %>
</div>

<section>
	<h2>
		<i>assignment</i>
		Dane
	</h2>
	<div class="vertical-split">
		<form>
			<label for="first-name-input">Imię:</label>
			<input
				type="text"
				id="first-name-input"
				autocomplete="off"
				value="<%= $.targetUser.name.first || "" %>"
				api="user/[userID]/update/names"
				name="firstName"
				<%= $.user.hasPermission($.targetUser.PERMISSIONS.EDIT) ? "" : "disabled" %>
			>

			<label for="last-name-input">Nazwisko:</label>
			<input
				type="text"
				id="last-name-input"
				autocomplete="off"
				value="<%= $.targetUser.name.last || "" %>"
				api="user/[userID]/update/names"
				name="lastName"
				<%= $.user.hasPermission($.targetUser.PERMISSIONS.EDIT) ? "" : "disabled" %>
			>

			<% if($.targetUser.roles.length > 0) { %>
				<label for="date-of-birth-input">Data urodzenia:</label>
				<input
					type="date" id="date-of-birth-input"
					min="<%= MIN_DATE %>"
					max="<%= datetime.format(new Date, "yyyy-MM-dd") %>"
					<% if($.targetUser.dateOfBirth) { %>
						value="<%= datetime.format($.targetUser.dateOfBirth, "yyyy-MM-dd") %>"
					<% } %>
					api="user/[userID]/update/dateOfBirth"
					<%= $.user.hasPermission($.targetUser.PERMISSIONS.EDIT) ? "" : " disabled" %>
				>
			<% } %>
		</form>
		<% if($.targetUser.email || $.targetUser.phone ||
			($.user.hasPermission($.targetUser.PERMISSIONS.EDIT) && (
				missingDetails.includes("email") || missingDetails.includes("phone")
			))
		) { %>
			<form>
				<label for="email-input">E-mail:</label>
				<input
					type="email"
					id="email-input"
					autocomplete="off"
					value="<%= $.targetUser.email || "" %>"
					api="user/[userID]/update/email"
					name="email"
					<%= $.user.hasPermission($.targetUser.PERMISSIONS.EDIT) ? "" : "disabled" %>
				>

				<label for="phone-input">Telefon:</label>
				<input
					type="tel"
					id="phone-input"
					autocomplete="off"
					value="<%= Text.formatPhone($.targetUser.phone, $.targetUser.phone?.startsWith("+353")) || "" %>"
					api="user/[userID]/update/phone"
					name="phone"
					<%= $.user.hasPermission($.targetUser.PERMISSIONS.EDIT) ? "" : "disabled" %>
				>
			</form>
		<% } %>
	</div>
	<div class="button-row">
		<% if($.user.hasPermission($.targetUser.PERMISSIONS.ACCESS_ACTIVITY)) { %>
			<button href="/users/<%= $.targetUser.id %>/log">
				<i>history</i>
				Log aktywności
			</button>
		<% } %>
	</div>
</section>

<% if($.targetUser.roles.length > 0 || $.targetUser.medical.entries.length > 0) { %>
	<section>
		<h2>
			<i>medical_information</i>
			Dane medyczne
		</h2>			
		<% if($.targetUser.confirmed) { %>	
			<% if($.targetUser.medical.entries.length == 0) { %>
				<article>
					<p><%= $.targetUser.displayName %> nie ma żadnych wymagań medycznych ani dietetycznych.</p>
				</article>
			<% } else { %>
				<div class="entry-grid">
					<% for(const category of $.targetUser.medical.displayCategories()) { %>
						<!-- <h3><%= category.title %></h3> -->
						<% for(const element of category.elements) { %>
							<div>
								<h3><%= element.title %></h3>
								<div class="entry-content">
									<p><%= element.symptoms %></p>
									<p><%= element.solutions %></p>
								</div>
							</div>
						<% } %>
					<% } %>
				</div>
			<% } %>
		<% } else if(!$.targetUser.medical.complete) { %>
			<p class="warning">
				<i>warning</i>
				Brakuje informacji
			</p>
		<% } %>

		<% if($.targetUser.medical.entries.length > 0 || $.user.hasPermission($.targetUser.PERMISSIONS.EDIT)) { %>
			<div class="button-row">
				<button href="/users/<%= $.targetUser.id %>/medical">
					<i>medical_information</i>
					<% if($.user.hasPermission($.targetUser.PERMISSIONS.EDIT)) { %>
						Edytuj dane medyczne
					<% } else { %>
						Szczegóły
					<% } %>
				</button>
			</div>
		<% } %>
	</section>
<% } %>

<% if($.targetUser.isParent) { %>
	<section<% if(blockAccess) { %> class="disabled"<% } %>>
		<h2>
			<i>supervisor_account</i>
			Podopieczni
		</h2>
		<div id="child-list" class="entry-grid">
			<% for(const child of $.targetUser.children || []) { %>
				<% child.defaultName = "(podopieczny)" %>
				<%~ include("templates/userEntry", {
					targetUser: child,
					warnings: $.user.id == $.targetUser.id && !child.confirmed ? ["Zatwierdź dane podopiecznego"] : []
				}) %>
			<% } %>
		</div>
	</section>
<% } else if($.targetUser.parents.length > 0 || $.user.hasPermission($.targetUser.PERMISSIONS.ADD_PARENT)) { %>
	<section<% if(blockAccess) { %> class="disabled"<% } %>>
		<h2>
			<i>supervisor_account</i>
			<% if($.targetUser.age !== null && $.targetUser.age >= Config.adultAge) { %>
				Kontakty alarmowe
			<% } else { %>
				Rodzice / opiekunowie
			<% } %>
		</h2>
		<div id="parent-list" class="entry-grid">
			<% for(const parent of $.targetUser.parents || []) { %>
				<% parent.defaultName = "(rodzic / opiekun)" %>
				<%~ include("templates/userEntry", {targetUser: parent}) %>
			<% } %>
		</div>
		<% if($.user.hasPermission($.targetUser.PERMISSIONS.ADD_PARENT)) { %>
			<button id="add-parent-button" opens-dialog="/users/<%= $.targetUser.id %>/addParent">
				<i>person_add</i>
				<span>Dodaj rodzica / opiekuna</span>
			</button>
		<% } %>
	</section>
<% } %>

<% if($.targetUser.roles.length > 0 && ($.targetUser.confirmed || !$.user.hasPermission($.targetUser.PERMISSIONS.APPROVE))) { %>
	<section<% if(blockAccess) { %> class="disabled"<% } %>>
		<h2>
			<i>groups</i>
			Funkcje w jednostkach
		</h2>
		<div class="entry-grid">
			<% for(const role of $.targetUser.roles) { %>
				<%~ include("/unit/templates/unitEntry", {
					targetUnit: role.unit,
					content: Text.capitalise(role.displayName)
				}) %>
			<% } %>
		</div>
	</section>
<% } %>

<% if($.targetUser.eventRoles.length > 0 && ($.targetUser.confirmed || !$.user.hasPermission($.targetUser.PERMISSIONS.APPROVE))) { %>
	<section<% if(blockAccess) { %> class="disabled"<% } %>>
		<h2>
		<i>hiking</i>
			Funkcje w akcjach
		</h2>
		<div class="entry-grid">
			<% for(const role of $.targetUser.eventRoles) { %>
				<%~ include("/event/templates/eventEntry.html", {
					targetEvent: role.unit,
					content: Text.capitalise(role.displayName)
				}) %>
			<% } %>
		</div>
	</section>
<% } %>

<% if($.targetUser.eventInvites.length > 0 && ($.targetUser.confirmed || !$.user.hasPermission($.targetUser.PERMISSIONS.APPROVE))) { %>
	<section<% if(blockAccess) { %> class="disabled"<% } %>>
		<h2>
		<i>hiking</i>
			Zaproszenia na akcje
		</h2>
		<div class="entry-grid">
			<% for(const event of $.targetUser.eventInvites) { %>
				<% const inviteState = event.participants.id($.targetUser.id)?.state %>
				<%~ include("/event/templates/eventEntry.html", {
					targetEvent: event,
					content: ({
						"pending": "Oczekujące zaproszenie",
						"accepted": "Zaakceptowane zaproszenie",
						"declined": "Odrzucone zaproszenie"
					})[inviteState]
				}) %>
			<% } %>
		</div>
	</section>
<% } %>

<% if($.targetUser.id == $.user.id) { %>
	<section>
		<h2>
			<i>key</i>
			Klucze dostępu
		</h2>
		<% if($.user.id == $.targetUser.id && $.targetUser.auth.keys.length == 0) { %>
			<p class="warning">
				<i>warning</i>
				Dodaj klucz dostępu do profilu, aby umożliwić logowanie i podpisywanie
			</p>
		<% } %>
		<p>Klucze dostępu są używane do logowania w systemie i do podpisywania ważnych informacji.</p>
		<div class="entry-grid medium">
			<% for(const key of $.targetUser.auth.keys) { %>
				<% const provider = key.provider %>
				<div>
					<div class="entry-header">
						<div class="entry-image">
							<% if(provider?.icon_light) { %>
								<img src="<%= provider?.icon_light %>">
							<% } else { %>
								<i>passkey</i>
							<% } %>
						</div>
						<div class="entry-title">
							<h3><%= provider?.name || "Klucz dostępu" %></h3>
						</div>
					</div>
					<dl>
						<dt>Dodano</dt>
						<dd><%= datetime.format(key.created, "yyyy-MM-dd HH:mm") %></dd>
						<dt>Ostatnio użyto</dt>
						<dd><%= key.lastUsed ? datetime.format(key.lastUsed, "yyyy-MM-dd HH:mm") : "Nigdy" %></dd>
					</dl>
					<div class="button-row">
						<button class="dangerous" api="passkey/<%= key.id %>/delete">
							<i>delete</i>
							<span>Usuń</span>
						</button>
					</div>
				</div>
			<% } %>
		</div>
		<button id="add-passkey-button" api="passkey/create">
			<i>add</i>
			<span>Utwórz klucz dostępu</span>
		</button>
	</section>
	<dialog id="delete-passkey-dialog">
		<h1>Trwale usunąć klucz dostępu?</h1>
		<p>Nie będzie można się nim więcej logować, ani używać do podpisywania.</p>
		<div class="button-row">
			<button>
				<i>arrow_back</i>
				<span>Anuluj</span>
			</button>
			<button class="dangerous" command>
				<i>delete</i>
				<span>Usuń</span>
			</button>
		</div>
	</dialog>
<% } %>

<% if($.targetUser.roles.length > 0) { %>
	<section>
		<h2>
			<i>check</i>
			Zatwierdzenie danych
		</h2>
		<% if($.targetUser.confirmed) { %>
			<%~ include("/templates/signature", {
				signature: $.targetUser.signature,
				user: $.user
			}) %>

			<% if($.user.hasPermission($.targetUser.PERMISSIONS.APPROVE) || $.user.hasPermission($.targetUser.PERMISSIONS.MANAGE)) { %>
				<% if($.user.hasPermission($.targetUser.PERMISSIONS.APPROVE)) { %>
					<p>Cofnij zatwierdzenie aby edytować dane.</p>
				<% } else { %>
					<p>Cofnij zatwierdzenie aby odrzucić podane wymagania.<br>Użytkownik będzie musiał ponownie je zatwierdzić.</p>
				<% } %>
				<div class="button-row">
					<button opens-dialog="unconfirm-dialog" class="dangerous">
						<i>undo</i>
						Cofnij zatwierdzenie
					</button>
				</div>
				<dialog id="unconfirm-dialog">
					<h1>Cofnięcie zatwierdzenia danych</h1>
					<p>
						Cofnąć zatwierdzenie danych użytkownika <strong><%= $.targetUser.displayName %></strong>?<br><br>
						<% if($.user.hasPermission($.targetUser.PERMISSIONS.APPROVE)) { %>
							Będzie można je edytować i ponownie zatwierdzić.
						<% } else { %>
							Użytkownik będzie musiał ponownie je zatwierdzić.
						<% } %>
					</p>
					<div class="button-row">
						<button>
							<i>arrow_back</i>
							Anuluj
						</button>
						<button api="user/[userID]/unconfirm" class="dangerous" command>
							<i>undo</i>
							Cofnij zatwierdzenie
						</button>
					</div>
				</dialog>
			<% } %>
			
		<% } else if($.user.hasPermission($.targetUser.PERMISSIONS.APPROVE)) { %>
			<% let confirmationAllowed = true %>
			<article>
				<h3>Dane osobowe</h3>
				<dl>
					<% if($.targetUser.name.first && $.targetUser.name.last) { %>
						<dt>Imię i nazwisko:</dt>
						<dd><%= $.targetUser.displayName %></dd>
					<% } else { %>
						<% confirmationAllowed = false %>
						<dt>Imię i nazwisko:</dt>
						<dd><i>warning</i> Brak imienia i nazwiska!</dd>
					<% } %>

					<% if($.targetUser.email) { %>
						<dt>Adres e-mail:</dt>
						<dd><%= $.targetUser.email %></dd>
					<% } else if(missingDetails.includes("email")) { %>
						<% confirmationAllowed = false %>
						<dt>Adres e-mail:</dt>
						<dd><i>warning</i> Brak adresu e-mail!</dd>
					<% } %>

					<% if($.targetUser.phone) { %>
						<dt>Numer telefonu:</dt>
						<dd><%= Text.formatPhone($.targetUser.phone) %></dd>
					<% } else if(missingDetails.includes("phone")) { %>
						<% confirmationAllowed = false %>
						<dt>Numer telefonu:</dt>
						<dd><i>warning</i> Brak numeru telefonu!</dd>
					<% } %>

					<% if($.targetUser.dateOfBirth) { %>
						<dt>Data urodzenia:</dt>
						<dd><%= datetime.format($.targetUser.dateOfBirth, "yyyy-MM-dd") %> (<%= $.targetUser.age %> lat)</dd>
					<% } else if(missingDetails.includes("dob")) { %>
						<% confirmationAllowed = false %>
						<dt>Data urodzenia:</dt>
						<dd><i>warning</i> Brak daty urodzenia!</dd>
					<% } %>
				</dl>
			</article>

			<article>
				<h3>Dane medyczne</h3>
				<% if($.targetUser.medical.entries.length == 0) { %>
					<p><%= $.targetUser.displayName %> nie ma żadnych wymagań medycznych ani dietetycznych.</p>
				<% } else { %>
					<p><%= $.targetUser.displayName %> ma następujące wymagania:</p>
					<ul>
						<% for(const entry of $.targetUser.medical.entries) { %>
							<li>
								<h4><%= entry.title %></h4>
								<dl>
									<% if(entry.symptoms) { %>
										<dt>Opis:</dt>
										<dd>
											<%= entry.symptoms %>
										</dd>
									<% } else { %>
										<% confirmationAllowed = false %>
										<dt>Opis:</dt>
										<dd><i>warning</i> Nie podano opisu!</dd>
									<% } %>
									<% if(entry.solutions) { %>
										<dt>Zalecenia:</dt>
										<dd>
											<%= entry.solutions %>
										</dd>
									<% } else { %>
										<% confirmationAllowed = false %>
										<dt>Zalecenia:</dt>
										<dd><i>warning</i> Nie podano zaleceń!</dd>
									<% } %>
								</dl>
							</li>
						<% } %>
					</ul>
				<% } %>
			</article>

			<% if($.targetUser.parents.length > 0) { %>
				<article>
					<h3>
						<% if($.targetUser.age !== null && $.targetUser.age >= Config.adultAge) { %>
							Kontakty alarmowe
						<% } else { %>
							Rodzice / opiekunowie
						<% } %>
					</h3>
					<ul>
						<% for(const parent of $.targetUser.parents) { %>
							<li>
								<h4><%= parent.displayName %></h4>
								<dl>
									<% if(parent.phone) { %>
										<dt>Telefon:</dt>
										<dd><%= Text.formatPhone(parent.phone) %></dd>
									<% } else { %>
										<% confirmationAllowed = false %>
										<dt>Brak numeru telefonu!</dt>
									<% } %>
									<% if(parent.email) { %>
										<dt>E-mail:</dt>
										<dd><%= parent.email %></dd>
									<% } else { %>
										<% confirmationAllowed = false %>
										<dt>Brak adresu e-mail!</dt>
									<% } %>
								</dl>
							</li>
						<% } %>
					</ul>
				</article>
			<% } %>
			
			<% if(!confirmationAllowed) { %>
				<p class="warning">
					<i>warning</i>
					Uzupełnij brakujące informacje aby kontynuować
				</p>
			<% } else { %>
				<div id="signature-form">
					<p>Podpisując, potwierdzasz że wszystkie powyższe informacje są prawdziwe i kompletne.</p>
					<%~ include("/templates/signature", {
						user: $.user
					}) %>
					<div class="button-row">
						<button api="user/[userID]/confirm" id="confirm-button">
							<i>check</i>
							Zatwierdź dane
						</button>
					</div>
				</div>
			<% } %>

		<% } else { %>
			<p class="warning">
				<i>warning</i>
				<% if($.targetUser.id == $.user.id && $.targetUser.age === null) { %>
					Ustaw datę urodzin aby zatwierdzić dane
				<% } else if($.targetUser.age === null || $.targetUser.age >= Config.adultAge) { %>
					Dane oczekują zatwierdzenia przez użytkownika <%= $.targetUser.displayName %>
				<% } else { %>
					Dane oczekują zatwierdzenia przez rodzica/opiekuna
				<% } %>
			</p>
		<% } %>
	</section>
<% } %>