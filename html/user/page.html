<% layout("/layouts/body", {
	title: $.targetUser.displayName,
	scripts: ["user/page"],
	styles: ["user/page"],
	meta: {
		userID: $.targetUser.id
	}
}) %>
<h1 id="user-title">
	<i>person</i>
	<%= $.targetUser.displayName %>
</h1>
<% if($.targetUser.org) { %>
	<p>(<%= Config.orgs[$.targetUser.org].name %>)</p>
<% } %>
<div class="button-row">
	<% if($.user.id == $.targetUser.id) { %>
		<button id="logout-button" api="logout">
			<i>logout</i>
			<span>Wyloguj</span>
		</button>
	<% } %>
	<% if($.user.hasPermission($.targetUser.PERMISSIONS.DELETE)) { %>
		<button id="delete-user-button" class="dangerous" api="user/[userID]/delete">
			<i>delete</i>
			<span>Usuń użytkownika</span>
		</button>
		<dialog id="delete-user-dialog">
			<h1>Trwale usunąć użytkownika <%= $.targetUser.displayName %>?</h1>
			<p>Użytkownik i wszystkie związane z nim dane zostaną trwale usunięte.</p>
			<div class="button-row">
				<button>
					<i>arrow_back</i>
					<span>Anuluj</span>
				</button>
				<button class="dangerous" command>
					<i>delete</i>
					<span>Usuń</span>
				</button>
			</div>
		</dialog>
	<% } %>
	<% if($.user.hasPermission($.targetUser.PERMISSIONS.GENERATE_ACCESS_CODE)) { %>
		<button id="generate-access-code-button" opens-dialog="/users/<%= $.targetUser.id %>/accessCode">
			<i>password</i>
			<span>Wygeneruj kod dostępu</span>
		</button>
	<% } %>
</div>

<%
	const md = $.targetUser.missingDetails
	const userWarnings = Array.conditional(
		md.includes("name"), "Brak imienia i nazwiska",
		md.includes("contact"), "Brak danych kontaktowych",
		md.includes("dob"), "Brak daty urodzenia",
		md.includes("medical"), "Nie zatwierdzone dane medyczne",
	)
%>
<% if(userWarnings.length > 0) { %>
	<section>
		<h2>
			<i>warning</i>
			Uwagi
		</h2>
		<% for(const warning of userWarnings) { %>
			<p class="warning">
				<i>warning</i>
				<%= warning %>
			</p>
		<% } %>
	</section>
<% } %>

<section>
	<h2>
		<i>assignment</i>
		Dane
	</h2>
	<div class="vertical-split">
		<form>
			<label for="first-name-input">Imię:</label>
			<input
				type="text"
				id="first-name-input"
				autocomplete="off"
				value="<%= $.targetUser.name.first || "" %>"
				api="user/[userID]/update/names"
				name="firstName"
				<%= $.user.hasPermission($.targetUser.PERMISSIONS.EDIT) ? "" : "disabled" %>
			>

			<label for="last-name-input">Nazwisko:</label>
			<input
				type="text"
				id="last-name-input"
				autocomplete="off"
				value="<%= $.targetUser.name.last || "" %>"
				api="user/[userID]/update/names"
				name="lastName"
				<%= $.user.hasPermission($.targetUser.PERMISSIONS.EDIT) ? "" : "disabled" %>
			>

			<% if($.targetUser.roles.length > 0) { %>
				<label for="date-of-birth-input">Data urodzenia:</label>
				<input
					type="date" id="date-of-birth-input"
					min="<%= MIN_DATE %>"
					max="<%= datetime.format(new Date, "yyyy-MM-dd") %>"
					<% if($.targetUser.dateOfBirth) { %>
						value="<%= datetime.format($.targetUser.dateOfBirth, "yyyy-MM-dd") %>"
					<% } %>
					api="user/[userID]/update/dateOfBirth"
					<%= $.user.hasPermission($.targetUser.PERMISSIONS.EDIT) ? "" : " disabled" %>
				>
			<% } %>
		</form>
		<% if($.targetUser.email || $.targetUser.phone ||
			($.user.hasPermission($.targetUser.PERMISSIONS.EDIT) && !$.targetUser.parents.hasID($.user.id))) { %>
			<form>
				<label for="email-input">E-mail:</label>
				<input
					type="email"
					id="email-input"
					autocomplete="off"
					value="<%= $.targetUser.email || "" %>"
					api="user/[userID]/update/email"
					name="email"
					<%= $.user.hasPermission($.targetUser.PERMISSIONS.EDIT) ? "" : "disabled" %>
				>

				<label for="phone-input">Telefon:</label>
				<input
					type="tel"
					id="phone-input"
					autocomplete="off"
					value="<%= Text.formatPhone($.targetUser.phone, $.targetUser.phone?.startsWith("+353")) || "" %>"
					api="user/[userID]/update/phone"
					name="phone"
					<%= $.user.hasPermission($.targetUser.PERMISSIONS.EDIT) ? "" : "disabled" %>
				>
			</form>
		<% } %>
	</div>
	<div class="button-row">
		<% if($.targetUser.roles.length > 0 || $.targetUser.medical.entries.length) { %>
			<button href="/users/<%= $.targetUser.id %>/medical">
				<i>medical_information</i>
				Dane medyczne
			</button>
		<% } %>
		<% if($.user.hasPermission($.targetUser.PERMISSIONS.ACCESS_ACTIVITY)) { %>
			<button href="/users/<%= $.targetUser.id %>/log">
				<i>history</i>
				Log aktywności
			</button>
		<% } %>
	</div>
</section>

<% if($.targetUser.id == $.user.id) { %>
	<section>
		<h2>
			<i>key</i>
			Klucze dostępu
		</h2>
		<p>Klucze dostępu są używane aby logować się do systemu. Można dodać kilka kluczy dostępu, aby umożliwić logowanie z różnych urządzeń.</p>
		<div class="entry-grid medium">
			<% for(const key of $.targetUser.auth.keys) { %>
				<% const provider = key.provider %>
				<div>
					<div class="entry-header">
						<div class="entry-image">
							<% if(provider?.icon_light) { %>
								<img src="<%= provider?.icon_light %>">
							<% } else { %>
								<i>passkey</i>
							<% } %>
						</div>
						<div class="entry-title">
							<h3><%= provider?.name || "Klucz dostępu" %></h3>
						</div>
					</div>
					<dl>
						<dt>Dodano</dt>
						<dd><%= datetime.format(key.created, "yyyy-MM-dd HH:mm") %></dd>
						<dt>Ostatnio użyto</dt>
						<dd><%= key.lastUsed ? datetime.format(key.lastUsed, "yyyy-MM-dd HH:mm") : "Nigdy" %></dd>
					</dl>
					<div class="button-row">
						<button class="dangerous" api="passkey/<%= key.id %>/delete">
							<i>delete</i>
							<span>Usuń</span>
						</button>
					</div>
				</div>
			<% } %>
		</div>
		<button id="add-passkey-button" api="passkey/create">
			<i>add</i>
			<span>Utwórz klucz dostępu</span>
		</button>
	</section>
	<dialog id="delete-passkey-dialog">
		<h1>Trwale usunąć klucz dostępu?</h1>
		<p>Nie będzie można się nim więcej logować.</p>
		<div class="button-row">
			<button>
				<i>arrow_back</i>
				<span>Anuluj</span>
			</button>
			<button class="dangerous" command>
				<i>delete</i>
				<span>Usuń</span>
			</button>
		</div>
	</dialog>
<% } %>

<% if($.targetUser.isParent) { %>
	<section>
		<h2>
			<i>supervisor_account</i>
			Podopieczni
		</h2>
		<div id="child-list" class="entry-grid">
			<% for(const child of $.targetUser.children || []) { %>
				<% child.defaultName = "(podopieczny)" %>
				<%~ include("templates/userEntry", {targetUser: child}) %>
			<% } %>
		</div>
	</section>
<% } else if($.targetUser.parents.length > 0 || $.user.hasPermission($.targetUser.PERMISSIONS.ADD_PARENT)) { %>
	<section>
		<h2>
			<i>supervisor_account</i>
			Rodzice / opiekunowie
		</h2>
		<div id="parent-list" class="entry-grid">
			<% for(const parent of $.targetUser.parents || []) { %>
				<% parent.defaultName = "(rodzic / opiekun)" %>
				<%~ include("templates/userEntry", {targetUser: parent}) %>
			<% } %>
		</div>
		<% if($.user.hasPermission($.targetUser.PERMISSIONS.ADD_PARENT)) { %>
			<button id="add-parent-button" api="user/[userID]/parent/create">
				<i>person_add</i>
				<span>Dodaj rodzica / opiekuna</span>
			</button>
		<% } %>
	</section>
<% } %>

<% if($.targetUser.roles.length > 0) { %>
	<section>
		<h2>
			<i>groups</i>
			Funkcje w jednostkach
		</h2>
		<div class="entry-grid">
			<% for(const role of $.targetUser.roles) { %>
				<%~ include("/unit/templates/unitEntry", {
					targetUnit: role.unit,
					content: Text.capitalise(role.displayName)
				}) %>
			<% } %>
		</div>
	</section>
<% } %>

<% if($.targetUser.eventRoles.length > 0) { %>
	<section>
		<h2>
		<i>hiking</i>
			Funkcje w akcjach
		</h2>
		<div class="entry-grid">
			<% for(const role of $.targetUser.eventRoles) { %>
				<%~ include("/event/templates/eventEntry.html", {
					targetEvent: role.unit,
					content: Text.capitalise(role.displayName)
				}) %>
			<% } %>
		</div>
	</section>
<% } %>

<% if($.targetUser.eventInvites.length > 0) { %>
	<section>
		<h2>
		<i>hiking</i>
			Zaproszenia na akcje
		</h2>
		<div class="entry-grid">
			<% for(const event of $.targetUser.eventInvites) { %>
				<% const inviteState = event.findUserInvite($.targetUser)?.state %>
				<%~ include("/event/templates/eventEntry.html", {
					targetEvent: event,
					content: ({
						"pending": "Oczekujące zaproszenie",
						"accepted": "Zaakceptowane zaproszenie",
						"declined": "Odrzucone zaproszenie"
					})[inviteState]
				}) %>
			<% } %>
		</div>
	</section>
<% } %>

<% if($.targetUser.eventApprovalRequests.length) { %>
	<section>
		<h2>
			<i>gavel</i>
			Zatwierdzenia akcji
		</h2>
		<div class="entry-grid">
			<% for(const event of $.targetUser.eventApprovalRequests) { %>
				<%
					const approvalState = event.getApprover($.targetUser)?.approved
					if(approvalState === undefined) continue
				%>
				<%~ include("/event/templates/eventEntry.html", {
					targetEvent: event,
					content: approvalState ? "Zatwierdzony" : "Oczekiwane zatwierdzenie",
				}) %>
			<% } %>
		</div>
	</section>
<% } %>
