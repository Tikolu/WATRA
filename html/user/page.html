<% layout("/layouts/body", {
	title: $.targetUser.displayName,
	scripts: ["user/page"],
	styles: ["user/page"],
	meta: {
		userID: $.targetUser.id
	}
}) %>
<h1 id="user-title">
	<i>person</i>
	<%= $.targetUser.displayName %>
</h1>
<div class="button-row">
	<% if($.user.id == $.targetUser.id) { %>
		<button id="logout-button" href="/logout">
			<i>logout</i>
			<span>Wyloguj</span>
		</button>
	<% } %>
	<% if($.user.hasPermission($.targetUser.PERMISSIONS.DELETE)) { %>
		<button id="delete-user-button" class="dangerous" api="user/[userID]/delete">
			<i>delete</i>
			<span>Usuń użytkownika</span>
		</button>
		<dialog id="delete-user-dialog">
			<h1>Trwale usunąć użytkownika <%= $.targetUser.displayName %>?</h1>
			<p>Użytkownik i wszystkie związane z nim dane zostaną trwale usunięte.</p>
			<div class="button-row">
				<button>
					<i>arrow_back</i>
					<span>Anuluj</span>
				</button>
				<button class="dangerous" command>
					<i>delete</i>
					<span>Usuń</span>
				</button>
			</div>
		</dialog>
	<% } %>
	<% if($.user.hasPermission($.targetUser.PERMISSIONS.MODIFY)) { %>
		<button id="generate-access-code-button" api="user/[userID]/accessCode/generate">
			<i>password</i>
			<span>Wygeneruj kod dostępu</span>
		</button>
		<dialog id="access-code-dialog">
			<h1>Kod dostępu</h1>
			<% if($.targetUser.id != $.user.id && !$.targetUser.isParent && $.targetUser.roles.every(f => !f.unit.type <= UnitType.DRUŻYNA)) { %>
				<p class="warning">
					<i>warning</i>
					Poniższy kod dostępu umożliwi dostęp do konta <%= $.targetUser.displayName %>, nie konta rodzica/opiekuna!
				</p>
			<% } %>
			<p>Jednorazowy kod dostępu dla użytkownika <%= $.targetUser.displayName %>:</p>
			<input type="text" class="access-code" id="user-access-code-container" disabled>
			<div class="button-row">
				<button>
					Zamknij
				</button>
			</div>
		</dialog>
	<% } %>
</div>

<hr>
<h2>
	<i>assignment</i>
	Dane
</h2>
<section>
	<form>
		<label for="first-name-input">Imię:</label>
		<input
			type="text"
			id="first-name-input"
			autocomplete="off"
			value="<%= $.targetUser.name.first || "" %>"
			api="user/[userID]/update/names"
			name="firstName"
			<%= $.user.hasPermission($.targetUser.PERMISSIONS.MODIFY) ? "" : "disabled" %>
		>

		<label for="last-name-input">Nazwisko:</label>
		<input
			type="text"
			id="last-name-input"
			autocomplete="off"
			value="<%= $.targetUser.name.last || "" %>"
			api="user/[userID]/update/names"
			name="lastName"
			<%= $.user.hasPermission($.targetUser.PERMISSIONS.MODIFY) ? "" : "disabled" %>
		>

		<% if($.targetUser.roles.length > 0) { %>
			<label for="date-of-birth-input">Data urodzenia:</label>
			<input
				type="date" id="date-of-birth-input"
				min="<%= MIN_DATE %>"
				max="<%= datetime.format(new Date, "yyyy-MM-dd") %>"
				<% if($.targetUser.dateOfBirth) { %>
					value="<%= datetime.format($.targetUser.dateOfBirth, "yyyy-MM-dd") %>"
				<% } %>
				api="user/[userID]/update/dateOfBirth"
				<%= $.user.hasPermission($.targetUser.PERMISSIONS.MODIFY) ? "" : " disabled" %>
			>
		<% } %>
	</form>
	<% if($.targetUser.email || $.targetUser.phone ||
		 ($.user.hasPermission($.targetUser.PERMISSIONS.MODIFY) && !$.targetUser.parents.hasID($.user.id))) { %>
		<form>
			<label for="email-input">E-mail:</label>
			<input
				type="email"
				id="email-input"
				autocomplete="off"
				value="<%= $.targetUser.email || "" %>"
				api="user/[userID]/update/email"
				name="email"
				<%= $.user.hasPermission($.targetUser.PERMISSIONS.MODIFY) ? "" : "disabled" %>
			>

			<label for="phone-input">Telefon:</label>
			<input
				type="tel"
				id="phone-input"
				autocomplete="off"
				value="<%= Text.formatPhone($.targetUser.phone, $.targetUser.phone?.startsWith("+353")) || "" %>"
				api="user/[userID]/update/phone"
				name="phone"
				<%= $.user.hasPermission($.targetUser.PERMISSIONS.MODIFY) ? "" : "disabled" %>
			>
		</form>
	<% } %>
</section>
<div class="button-row">
	<% if($.targetUser.roles.length > 0 || $.targetUser.medical.entries.length) { %>
		<button href="/users/<%= $.targetUser.id %>/medical">
			<i>medical_information</i>
			Dane medyczne
		</button>
	<% } %>
	<% if($.user.hasPermission($.targetUser.PERMISSIONS.MODIFY)) { %>
		<button href="/users/<%= $.targetUser.id %>/log">
			<i>history</i>
			Log aktywności
		</button>
	<% } %>
</div>

<% if($.targetUser.isParent) { %>
	<hr>
	<h2>
		<i>supervisor_account</i>
		Podopieczni
	</h2>
	<div id="child-list" class="unit-grid">
		<% for(const child of $.targetUser.children || []) { %>
			<% child.defaultName = "(podopieczny)" %>
			<%~ include("templates/userEntry", {targetUser: child}) %>
		<% } %>
	</div>
<% } else if($.targetUser.parents.length > 0 || $.user.hasPermission($.targetUser.PERMISSIONS.ADD_PARENT)) { %>
	<hr>
	<h2>
		<i>supervisor_account</i>
		Rodzice / opiekunowie
	</h2>
	<div id="parent-list" class="unit-grid">
		<% for(const parent of $.targetUser.parents || []) { %>
			<% parent.defaultName = "(rodzic / opiekun)" %>
			<%~ include("templates/userEntry", {targetUser: parent}) %>
		<% } %>
	</div>
	<% if($.user.hasPermission($.targetUser.PERMISSIONS.ADD_PARENT)) { %>
		<button id="add-parent-button" api="user/[userID]/parent/create">
			<i>person_add</i>
			<span>Dodaj rodzica / opiekuna</span>
		</button>
	<% } %>
<% } %>

<% if($.targetUser.roles.length > 0) { %>
	<hr>
	<h2>
		<i>groups</i>
		Funkcje w jednostkach
	</h2>
	<div id="unit-list" class="unit-grid">
		<% for(const role of $.targetUser.roles) { %>
			<%~ include("/unit/templates/unitEntry", {
				targetUnit: role.unit,
				content: Text.capitalise(role.displayName)
			}) %>
		<% } %>
	</div>
<% } %>

<% if($.targetUser.eventRoles.length > 0) { %>
	<hr>
	<h2>
	<i>hiking</i>
		Funkcje w akcjach
	</h2>
	<div class="unit-grid">
		<% for(const role of $.targetUser.eventRoles) { %>
			<%~ include("/event/templates/eventEntry.html", {
				targetEvent: role.unit,
				content: Text.capitalise(role.displayName)
			}) %>
		<% } %>
	</div>
<% } %>

<% if($.targetUser.eventInvites.length > 0) { %>
	<hr>
	<h2>
	<i>hiking</i>
		Zaproszenia na akcje
	</h2>
	<div class="unit-grid">
		<% for(const event of $.targetUser.eventInvites) { %>
			<% const inviteState = event.findUserInvite($.targetUser)?.state %>
			<%~ include("/event/templates/eventEntry.html", {
				targetEvent: event,
				content: ({
					"pending": "Oczekujące zaproszenie",
					"accepted": "Zaakceptowane zaproszenie",
					"declined": "Odrzucone zaproszenie"
				})[inviteState]
			}) %>
		<% } %>
	</div>
<% } %>

<% if($.targetUser.eventApprovalRequests.length) { %>
	<hr>
	<h2>
		<i>gavel</i>
		Zatwierdzenia akcji
	</h2>
	<div class="unit-grid">
		<% for(const event of $.targetUser.eventApprovalRequests) { %>
			<%
				const approvalState = event.getApprover($.targetUser)?.approved
				if(approvalState === undefined) continue
			%>
			<%~ include("/event/templates/eventEntry.html", {
				targetEvent: event,
				content: approvalState ? "Zatwierdzony" : "Oczekiwane zatwierdzenie",
			}) %>
		<% } %>
	</div>
<% } %>
