<% layout("/layouts/main", {
	title: $.targetUser.displayName,
	scripts: ["user/page", "signature"],
	styles: ["signature"],
	meta: {
		userID: $.targetUser.id,
		lastLogin: $.targetUser.auth.lastLogin
	}
}) %>
<%
	const blockAccess = Config.passkeyRequired && $.user.auth.keys.length == 0
%>

<h1 id="user-title">
	<%~ icon`person` %>
	<%= $.targetUser.displayName %>
</h1>
<% if($.targetUser.roles.length > 0 && ($.targetUser.org || $.user.hasPermission($.targetUser.PERMISSIONS.SET_ORG))) { %>
	<%~ include("orgOptions", $) %>
<% } %>

<% if($.targetUser.archived) { %>
	<article>
		<p>
			<b><%~ icon`archive` %> Profil zarchiwizowany</b><br>
			<% if($.targetUser.id == $.user.id || $.user.children.some(child => child.id == $.targetUser.id)) { %>
				Skontaktuj się z przełożonym aby odblokować profil.
			<% } %>
		</p>
	</article>
<% } %>

<div class="button-row">
	<% if($.user.hasPermission($.targetUser.PERMISSIONS.ACCESS_ACTIVITY)) { %>
		<button href="/users/<%= $.targetUser.id %>/log">
			<%~ icon`history` %>
			Log aktywności
		</button>
	<% } %>
	<% if($.user.id == $.targetUser.id) { %>
		<button id="logout-button" api="logout">
			<%~ icon`logout` %>
			Wyloguj
		</button>
	<% } %>
	<% if($.user.hasPermission($.targetUser.PERMISSIONS.GENERATE_ACCESS_CODE)) { %>
		<%
			let showAccessCodeWarning = (() => {
				if($.targetUser.isParent) return false
				if($.targetUser.id == $.user.id) return false
				if($.targetUser.parents.hasID($.user.id)) return false
				if($.targetUser.isAdult) return false
				return true
			})()
		%>
		<button
			id="generate-access-code-button"
			<% if(showAccessCodeWarning) { %>
				opens-dialog="access-code-warning-dialog"
			<% } else { %>
				opens-dialog="/users/<%= $.targetUser.id %>/accessCode"
			<% } %>
		>
			<%~ icon`password` %>
			Wygeneruj kod rejestracyjny
		</button>
		<% if(showAccessCodeWarning) { %>
			<dialog id="access-code-warning-dialog">
				<h1>
					<%~ icon`warning` %>
					Kod dla profilu <%= $.targetUser.displayName %>
				</h1>
				<article class="warning">
					<p>
						<%~ icon`warning` %>
						<b>Uwaga - Kod nie umożliwi dostępu do profilu rodzica / opiekuna</b>
					</p>
					<p>Kod umożliwi dostęp tylko do profilu <%= $.targetUser.displayName %>.</p>
				</article>
				<p>Jeśli <%= $.targetUser.name.first || "osoba" %> jest osobą niepełnoletnią, nie będzie mógł zatwierdzić własnych danych.</p>
				<p>Na pewno kontynuować z wygenerowaniem kodu?</p>
				<div class="button-row">
					<button>
						<%~ icon`arrow_back` %>
						Anuluj
					</button>
					<button opens-dialog="/users/<%= $.targetUser.id %>/accessCode">
						<%~ icon`password` %>
						Kontynuuj
					</button>
				</div>
			</dialog>
		<% } %>
	<% } %>
	<% if($.user.hasPermission($.targetUser.PERMISSIONS.ARCHIVE)) { %>
		<% if($.targetUser.archived) { %>
			<button id="unarchive-user-button" api="user/[userID]/unarchive">
				<%~ icon`unarchive` %>
				Cofnij archiwizację
			</button>
		<% } else { %>
			<button id="archive-user-button" api="user/[userID]/archive">
				<%~ icon`archive` %>
				Archiwizuj użytkownika
			</button>
		<% } %>
	<% } %>
	<% if($.user.hasPermission($.targetUser.PERMISSIONS.DELETE)) { %>
		<button id="delete-user-button" class="dangerous" api="user/[userID]/delete">
			<%~ icon`delete` %>
			<% if($.targetUser.children.length > 0 && $.targetUser.children.every(child => child.isAdult)) { %>
				Usuń kontakt alarmowy
			<% } else if($.targetUser.isParent && $.targetUser.roles.length == 0) { %>
				Usuń rodzica
			<% } else { %>
				Usuń użytkownika
			<% } %>
		</button>
		<dialog id="delete-user-dialog">
			<h1>Trwale usunąć użytkownika <%= $.targetUser.displayName %>?</h1>
			<p>Użytkownik i wszystkie jego dane zostaną trwale usunięte.</p>
			<div class="button-row">
				<button>
					<%~ icon`arrow_back` %>
					Anuluj
				</button>
				<button class="dangerous" command>
					<%~ icon`delete` %>
					Usuń
				</button>
			</div>
		</dialog>
	<% } %>
</div>

<% if(!blockAccess) { %>
	<%~ include("detailsSection", $) %>
<% } %>

<% if(!blockAccess && ($.targetUser.roles.length > 0 || $.targetUser.medical.entries.length > 0)) { %>
	<%~ include("medicalSection", $) %>
<% } %>

<% if(!blockAccess && $.targetUser.isParent) { %>
	<section>
		<h2>
			<%~ icon`supervisor_account` %>
			Podopieczni
		</h2>
		<div id="child-list" class="entry-grid">
			<% for(const child of $.targetUser.children || []) { %>
				<% child.defaultName = "(podopieczny)" %>
				<%~ include("/user/templates/userEntry", {
					targetUser: child,
					warnings: (
						$.user.id == $.targetUser.id &&
						!child.confirmed &&
						$.user.hasPermission(child.PERMISSIONS.APPROVE)
					) ? ["Zatwierdź dane podopiecznego"] : []
				}) %>
			<% } %>
		</div>
	</section>
<% } else if(!blockAccess && ($.targetUser.parents.length > 0 || $.user.hasPermission($.targetUser.PERMISSIONS.ADD_PARENT))) { %>
	<section>
		<h2>
			<%~ icon`supervisor_account` %>
			<% if($.targetUser.isAdult) { %>
				Kontakty alarmowe
			<% } else { %>
				Rodzice / opiekunowie
			<% } %>
		</h2>
		<div id="parent-list" class="entry-grid">
			<% for(const parent of $.targetUser.parents || []) { %>
				<% parent.defaultName = "(rodzic / opiekun)" %>
				<%~ include("/user/templates/userEntry", {targetUser: parent}) %>
			<% } %>
		</div>
		<% if($.user.hasPermission($.targetUser.PERMISSIONS.ADD_PARENT)) { %>
			<button id="add-parent-button" opens-dialog="/users/<%= $.targetUser.id %>/addParent">
				<%~ icon`person_add` %>
				<% if($.targetUser.isAdult) { %>
					Dodaj kontakt alarmowy
				<% } else { %>
					Dodaj rodzica / opiekuna
				<% } %>
			</button>
		<% } %>
	</section>
<% } %>

<% if(!blockAccess && $.targetUser.roles.length > 0 && ($.targetUser.confirmed || !$.user.hasPermission($.targetUser.PERMISSIONS.APPROVE))) { %>
	<section>
		<h2>
			<%~ icon`groups` %>
			Funkcje w jednostkach
		</h2>
		<div class="entry-grid">
			<% for(const role of $.targetUser.roles) { %>
				<%~ include("/unit/templates/unitEntry", {
					targetUnit: role.unit,
					content: Text.capitalise(role.displayName)
				}) %>
			<% } %>
		</div>
	</section>
<% } %>

<% if(!blockAccess && $.eventRoles.length > 0 && ($.targetUser.confirmed || !$.user.hasPermission($.targetUser.PERMISSIONS.APPROVE))) { %>
	<section>
		<h2>
		<%~ icon`hiking` %>
			Funkcje w akcjach
		</h2>
		<div class="entry-grid">
			<% for(const role of $.eventRoles) { %>
				<%~ include("/event/templates/eventEntry.html", {
					targetEvent: role.unit,
					content: Text.capitalise(role.displayName)
				}) %>
			<% } %>
		</div>
	</section>
<% } %>

<% if(!blockAccess && $.eventInvites.length > 0 && ($.targetUser.confirmed || !$.user.hasPermission($.targetUser.PERMISSIONS.APPROVE))) { %>
	<section>
		<h2>
		<%~ icon`hiking` %>
			Zaproszenia na akcje
		</h2>
		<div class="entry-grid">
			<% for(const {event, inviteState} of $.eventInvites) { %>
				<%~ include("/event/templates/eventEntry.html", {
					targetEvent: event,
					content: ({
						"pending": "Oczekujące zaproszenie",
						"accepted": "Zaakceptowane zaproszenie",
						"declined": "Odrzucone zaproszenie"
					})[inviteState]
				}) %>
			<% } %>
		</div>
	</section>
<% } %>

<% if($.targetUser.id == $.user.id) { %>
	<%~ include("passkeySection", $) %>
<% } %>

<% if($.targetUser.roles.length > 0) { %>
	<%~ include("confirmationSection", $) %>
<% } %>