<% layout("/layouts/body", {
	title: $.targetEvent.displayName,
	scripts: ["event/page"],
	styles: ["event/page"],
	meta: {
		eventID: $.targetEvent.id
	}
}) %>
<h1 id="event-title"><%= $.targetEvent.displayName %></h1>
<p id="event-type"><%= $.targetEvent.typeName %></p>

<% if($.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)) { %>
	<hr>
	<h2>
		<i>manufacturing</i>
		Szczegóły akcji
	</h2>
	<form>
		<label for="event-name-input">Nazwa:</label>
		<input
			type="text"
			id="event-name-input"
			autocomplete="off"
			value="<%= $.targetEvent.name || "" %>"
			api="event/[eventID]/update/name"
			name="name"
			<% $.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY) ? "" : "disabled" %>
		>
	</form>
<% } %>

<h3>
	<i>assignment</i>
	Opis akcji
</h3>
<textarea
	id="event-description-input"
	api="event/[eventID]/update/description"
	name="description"
	<% if(!$.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)) { %>
		disabled
	<% } %>
><%= $.targetEvent.description || "" %></textarea>

<section>
	<% if($.targetEvent.dates.start || $.targetEvent.dates.end || $.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)) { %>
		<div>
			<h3>
				<i>calendar_today</i>
				Daty
			</h3>
			<form>
				<label for="event-name-input">Od:</label>
				<input
					type="datetime-local"
					id="event-start-date-input"
					min="<%= MIN_DATE %>T00:00"
					max="<%= MAX_DATE %>T00:00"
					<% if($.targetEvent.dates.start) { %>
						value="<%= datetime.format($.targetEvent.dates.start, "yyyy-MM-ddTHH:mm") %>"
					<% } %>
					api="event/[eventID]/update/dates"
					name="startDate"
					<% if(!$.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)) { %>
						disabled
					<%- } %>
				>

				<label for="event-name-input">Do:</label>
				<input
					type="datetime-local"
					id="event-end-date-input"
					min="<%= MIN_DATE %>T00:00"
					max="<%= MAX_DATE %>T00:00"
					<% if($.targetEvent.dates.end) { %>
						value="<%= datetime.format($.targetEvent.dates.end, "yyyy-MM-ddTHH:mm") %>"
					<% } %>
					api="event/[eventID]/update/dates"
					name="endDate"
					<% if(!$.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)) { %>
						disabled
					<%- } %>
				>
			</form>
		</div>
	<% } %>
	<% if($.targetEvent.location || $.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)) { %>
		<div>
			<h3>
				<i>distance</i>
				Lokalizacja
			</h3>
			<form>
				<input
					type="text"
					id="event-location-input"
					autocomplete="off"
					value="<%= $.targetEvent.location || "" %>"
					api="event/[eventID]/update/location"
					name="location"
					placeholder="(brak lokalizacji)"
					<% if(!$.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)) { %>
						disabled
					<% } %>
				>
			</form>
		</div>
	<% } %>
</section>

<% if($.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)) { %>
	<br>
	<button id="delete-event-button" class="dangerous" api="event/[eventID]/delete">
		<i>delete</i>
		<span>Usuń akcję</span>
	</button>
	<dialog id="delete-event-dialog">
		<h1>Trwale usunąć <%= $.targetEvent.displayName %>?</h1>
		<p>Akcja i wszystkie związane z nią dane zostaną trwale usunięte.</p>
		<div class="button-row">
			<button>
				<i>arrow_back</i>
				<span>Anuluj</span>
			</button>
			<button class="dangerous" command>
				<i>delete</i>
				<span>Usuń</span>
			</button>
		</div>
	</dialog>
<% } %>

<% if($.user.hasPermission($.targetEvent.PERMISSIONS.PARTICIPANT_ACCESS)) { %>
	<% if($.targetEvent.funkcje?.length > 0 || $.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)) { %>
		<hr>
		<h2>
			<i>article_person</i>
			Kadra
		</h2>
		<div id="event-member-list" class="unit-grid">
			<% for(const funkcja of $.targetEvent.funkcje || []) { %>
				<% if(funkcja.type === FunkcjaType.SZEREGOWY && $.targetEvent.findUserInvite(funkcja.user)) continue %>
				<%~ include("/user/templates/userEntry", {
					targetUser: funkcja.user,
					description: Text.capitalise(funkcja.displayName),
					warnings: Array.conditional(
						!funkcja.user.medical.confirmed && funkcja.user.funkcje.length > 0, "Nie zatwierdzone dane medyczne"
					)
				}) %>
			<% } %>
		</div>
		<% if($.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)) { %>
			<button opens-dialog="/events/<%= $.targetEvent.id %>/mianowanie">
				<i>add_moderator</i>
				<span>Mianuj na funkcję</span>
			</button>
		<% } %>
	<% } %>
<% } %>

<% if(
	$.targetEvent.invitedUnits.length > 0 ||
	$.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY) ||
	$.targetEvent.invitedUnits.some(i => $.user.hasPermission(i.unit.PERMISSIONS.MODIFY))
) { %>
	<hr>
	<h2>
		<% if($.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)) { %>
			Uczestnicy
		<% } else { %>
			Zaproszone jednostki
		<% } %>
	</h2>
	<% if($.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)) { %>
		<button href="/events/<%= $.targetEvent.id %>/inviteUnits" class="add-user-button">
			<i>person_add</i>
			<span>Zaproś jednostki</span>
		</button>
	<% } %>
	<% for(const unitInvite of $.targetEvent.invitedUnits || []) { %>
		<%
			if(unitInvite.state == "declined" && !$.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)) continue
			if(
				unitInvite.state == "pending" &&
				!$.user.hasPermission(unitInvite.unit.PERMISSIONS.MODIFY) &&
				!$.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)
			) continue
		%>
		<div class="section-unit">
			<h3><%= unitInvite.unit.displayName %></h3>
			<% if($.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)) { %>
				<p>
					<% if(unitInvite.state == "accepted") { %>
						Zaakceptowano zaproszenie <i>check</i>
					<% } else if(unitInvite.state == "declined") { %>
						Odrzucono zaproszenie <i>cancel</i>
					<% } else if(unitInvite.state == "pending") { %>
						Oczekiwana odpowiedź... <i class="spin">progress_activity</i>
					<% } %>
				</p>
				<% if(unitInvite.state == "pending" || unitInvite.state == "accepted") { %>
					<button class="dangerous" api="event/[eventID]/unit/<%= unitInvite.unit.id %>/uninvite">
						<i>undo</i>
						<span>Cofnij zaproszenie</span>
					</button>
				<% } %>
				<% if($.user.hasPermission(unitInvite.unit.PERMISSIONS.MODIFY) && unitInvite.state != "declined") { %>
					<hr>
				<% } %>
			<% } %>
			<% if($.user.hasPermission(unitInvite.unit.PERMISSIONS.MODIFY)) { %>
				<% if(unitInvite.state == "accepted") { %>
					<p>Zaproszeni uczestnicy: <%= unitInvite.invitedUsers.length %></p>
					<div class="button-row">
						<button opens-dialog="/events/<%= $.targetEvent.id %>/chooseParticipants?unit=<%= unitInvite.unit.id %>">
							<i>group_add</i>
							<% if(unitInvite.invitedUsers.length > 0) { %>
								<span>Edytuj uczestników</span>
							<% } else { %>
								<span>Dodaj uczestników</span>
							<% } %>
						</button>
					</div>
				<% } else if(unitInvite.state == "pending") { %>
					<p>Oczekujące zaproszenie...</p>
					<div class="button-row">
						<button api="unit/<%= unitInvite.unit.id %>/event/[eventID]/invitation/accept">
							<i>check</i>
							<span>Zaakceptuj</span>
						</button>
						<button class="dangerous" api="unit/<%= unitInvite.unit.id %>/event/[eventID]/invitation/decline">
							<i>close</i>
							<span>Odrzuć</span>
						</button>
					</div>
				<% } %>
			<% } %>
			<% if(
				unitInvite.invitedUsers.length &&
				(
					$.user.hasPermission(unitInvite.unit.PERMISSIONS.MODIFY) || 
					$.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)
				)
			) { %>
				<div class="unit-grid">
					<% for(const userInvite of unitInvite.invitedUsers) { %>
						<%
							let content = ""
							if(userInvite.state == "accepted") {
								content = "Zaakceptowano"
							} else if(userInvite.state == "declined") {
								content = "Odrzucono"
							} else if(userInvite.state == "pending") {
								content = "Oczekiwana odpowiedź..."
							}
						%>
						<%~ include("/user/templates/userEntry", {
							targetUser: userInvite.user,
							content
						}) %>
					<% } %>
				</div>
			<% } %>
		</div>
	<% } %>
<% } %>

<% if($.approvalParticipants?.length) { %>
	<hr>
	<h2>Uczestnictwo</h2>
	<% for(const userInvite of $.approvalParticipants) { %>
		<div class="section-unit">
			<h3><%= userInvite.user.displayName %></h3>
			<p>
				<% if(userInvite.state == "pending") { %>
					<i>help</i>
					Oczekiwana odpowiedź...
				<% } else if(userInvite.state == "accepted") { %>
					<i>check_circle</i>
					Zgłoszony
				<% } else if(userInvite.state == "declined") { %>
					<i>cancel</i>
					Odrzucono
				<% } %>
			</p>
			<button opens-dialog="/events/<%= $.targetEvent.id %>/participation?participant=<%= userInvite.user.id %>">
				<% if(userInvite.state == "pending") { %>
					Odpowiedz
				<% } else { %>
					Zmień odpowiedź
				<% } %>
			</button>
		</div>
	<% } %>
<% } %>

<% if(
	$.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY) ||
	$.user.hasPermission($.targetEvent.PERMISSIONS.APPROVE)
) { %>
	<hr>
	<h2>Zatwierdzenie</h2>
	<% if($.targetEvent.approvalState) { %>
		<p><i>check_circle</i> Akcja zatwierdzona</p>
	<% } else { %>
		<p><i>cancel</i> Akcja nie jest zatwierdzona!</p>
	<% } %>
	<% if($.targetEvent.approvers.length == 0) { %>
		<% if($.targetEvent.invitedUnits.filter(i => i.state == "accepted").length == 0) { %>
			<p>Proces zatwierdzenia akcji można rozpocząć po zaakceptowaniu zaproszenia przez przynajmniej jedną jednostkę</p>
		<% } else { %>
			<p>Wybierz zatwierdzających aby rozpocząć</p>
		<% } %>
	<% } %>
	<% for(const approver of $.targetEvent.approvers) { %>
		<div class="section-unit approval-block">
			<h3><%= approver.funkcja.user.displayName %></h3>
			<p><%= Text.capitalise(approver.funkcja.displayName) %>, <%= approver.funkcja.unit.displayName %></p>
			<% if(approver.approved) { %>
				<p>
					Zatwierdzono <i>check</i><br>
					<small><%= datetime.format(approver.approvedAt, "dd-MM-yyyy HH:mm") %></small>
				</p>
			<% } else if(approver.funkcja.user.id != $.user.id) { %>
				<p>Oczekiwane zatwierdzenie... <i class="spin">progress_activity</i></p>
			<% } %>
			
			<% if(approver.funkcja.user.id == $.user.id) { %>
				<div class="button-row">
					<% if(approver.approved) { %>
						<button api="event/[eventID]/approval/unapprove" class="dangerous">
							<i>undo</i>
							<span>Cofnij zatwierdzenie</span>
						</button>
					<% } else { %>
						<button opens-dialog="/events/<%= $.targetEvent.id %>/approve">
							<i>check</i>
							<span>Zatwierdź</span>
						</button>
					<% } %>
				</div>
			<% } %>
		</div>
	<% } %>
	<% if($.user.hasPermission($.targetEvent.PERMISSIONS.MODIFY)) { %>
		<button opens-dialog="/events/<%= $.targetEvent.id %>/chooseApprovers"><i>person_check</i>Wybierz zatwierdzających</button>
	<% } %>
<% } %>