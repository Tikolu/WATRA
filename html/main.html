<% layout("/layouts/main", {
	title: `WATRA - ${Config.systemTitle || "Strona główna"}`,
	scripts: ["home"],
	styles: ["home"],
	navPath: false,
	user: $.user
}) %>

<h1>
	<img class="watra-logo" src="/watra.svg">
	<span>WATRA<span>
</h1>
<p>
	Wersja <%= VERSION %>&#x20;
	<% if(Config.systemTitle) { %>
		- <%= Config.systemTitle %>
	<% } %>
</p>

<% if($.user.name.first) { %>
	<h3>Czuwaj, <a href="/users/<%= $.user.id %>"><%= $.user.name.first %></a>!</h3>
<% } else { %>
	<h3>Czuwaj!</h3>
<% } %>


<% if(Config.news.length > 0) { %>
	<section>
		<h2>
			<%~ icon`news` %>
			Ogłoszenia
		</h2>
		<div class="entry-grid" id="news-list">
			<% for(const newsEntry of Config.news) { %>
				<a opens-dialog="/news/<%= newsEntry.id %>" data-auto-open="<%= newsEntry.autoOpen || "never" %>" data-id="<%= newsEntry.id %>">
					<div class="entry-header">
						<div class="entry-image">
							<%~ icon`news` %>
						</div>
						<div class="entry-title">
							<h3><%= newsEntry.title %></h3>
							<p><%= newsEntry.description || "" %></p>
						</div>
					</div>
				</a>
			<% } %>
		</div>
	</section>
<% } %>
<% 
	const blockAccess = Config.passkeyRequired && $.user.auth.keys.length == 0
%>
<% if(!$.user.profileComplete || blockAccess || $.user.archived) { %>
	<% if(blockAccess) { %>
		<article>
			<p>
				<b><%~ icon`info` %> Witamy na platformie WATRA!</b><br>
				Pierwszy krok - aby odblokować wszystkie funkcje systemu, dodaj klucz dostępu do swojego profilu poniżej.
			</p>
		</article>
	<% } %>
	<section>
		<h2>
			<%~ icon`person` %>
			Twój profil
		</h2>
		<div class="entry-grid medium">
			<%~ include("user/templates/userEntry", {
				targetUser: $.user,
				warnings: Array.conditional(
					!$.user.profileComplete, "Uzupełnij dane profilu",
					blockAccess, "Dodaj klucz dostępu",
					$.user.archived, "Profil zarchiwizowany"
				)
			}) %>
		</div>
	</section>
<% } %>

<% if($.user.roles.length > 0) { %>
	<section<% if(blockAccess) { %> class="disabled"<% } %>>
		<h2>
			<%~ icon`groups` %>
			Jednostki
		</h2>
		<div class="entry-grid">
			<% for(const role of $.user.roles) { %>
				<% 
					const unitEventInvite = role.hasTag("manageEventInvite") &&
						role.unit.eventInvites.some(event => event.invitedUnits.id(role.unit.id)?.state == "pending")
				%>
				<%~ include("unit/templates/unitEntry", {
					targetUnit: role.unit,
					warnings: Array.conditional(
						!role.unit.name, "Ustaw nazwę jednostki",
						unitEventInvite, "Oczekujące zaproszenia na akcje"
					)
				}) %>
			<% } %>
		</div>
	</section>
<% } %>

<% if($.user.children.length > 0) { %>
	<section<% if(blockAccess) { %> class="disabled"<% } %>>
		<h2>
			<%~ icon`supervisor_account` %>
			Podopieczni
		</h2>
		<div class="entry-grid">
			<% for(const child of $.user.children) { %>
				<%
					const warnings = []
					if(!child.confirmed && $.user.hasPermission(child.PERMISSIONS.APPROVE)) warnings.push("Zatwierdź dane podopiecznego")
				%>
				<%~ include("user/templates/userEntry", {
					targetUser: child,
					warnings
				}) %>
			<% } %>
		</div>
	</section>
<% } %>

<% if($.events.length) { %>
	<section<% if(blockAccess) { %> class="disabled"<% } %>>
		<h2>
			<%~ icon`hiking` %>
			Akcje
		</h2>
		<div class="entry-grid">
			<% for(const {event, inviteStates, approvalState} of $.events) { %>
				<%~ include("event/templates/eventEntry", {
					targetEvent: event,
					warnings: Array.conditional(
						inviteStates.includes("pending") && event.registrationOpen, "Oczekiwana odpowiedź",
						approvalState === false, event.isPast ? "Akcja nie została zatwierdzona" : "Oczekujące zatwierdzenie"
					)
				}) %>
			<% } %>
		</div>
	</section>
<% } %>

<%~ include("form/list", $) %>