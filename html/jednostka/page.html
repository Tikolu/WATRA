<% layout("/layouts/body", {
	title: $.targetJednostka.displayName,
	scripts: ["jednostka/page"],
	// styles: ["jednostka/page"],
	meta: {
		jednostkaID: $.targetJednostka.id
	}
}) %>
<h1 id="jednostka-title"><%= $.targetJednostka.displayName %></h1>
<% if($.targetJednostka.upperJednostki?.length > 0) { %>
	<p>(<%= $.targetJednostka.typeName %> w <%~ include("/templates/linkList", $.targetJednostka.upperJednostki.map(j => [`/jednostki/${j.id}`, j.displayName])) %>)</p>
<% } %>

<% if($.user.hasPermission($.targetJednostka.PERMISSIONS.MODIFY)) { %>
	<hr>
	<h2>Ustawienia</h2>
	<form>
		<label for="jednostka-name-input">Nazwa:</label>
		<input
			type="text"
			id="jednostka-name-input"
			autocomplete="off"
			value="<%= $.targetJednostka.name || "" %>"
			api="jednostka/[jednostkaID]/update/name"
			<% $.user.hasPermission($.targetJednostka.PERMISSIONS.MODIFY) ? "" : "disabled" %>
		>
	</form>

	<% if($.usersForMianowanie?.length > 0) { %>
		<h3>Mianowanie na funkcję</h3>
		<form>
			<label for="mianowanie-user-select">Użytkownik:</label>
			<select id="mianowanie-user-select" name="memberID">
				<option selected hidden></option>
				<% for(const member of $.usersForMianowanie) { %>
					<option value="<%= member.id %>"><%= member.displayName %></option>
				<% } %>
			</select>

			<label for="mianowanie-funkcja-select">Funkcja:</label>
			<select id="mianowanie-funkcja-select" name="funkcjaType">
				<option selected hidden></option>
				<% for(const [funkcjaLevel, funkcjaName] of $.targetJednostka.getFunkcjaOptions() || []) { %>
					<option value="<%= funkcjaLevel %>"><%= funkcjaName %></option>
				<% } %>
				<option disabled></option>
				<option value="remove">(usuń z jednostki)</option>
			</select>

			<button id="mianowanie-button" api="jednostka/[jednostkaID]/member/[memberID]/mianujNaFunkcję">
				<i>check</i>
				<span>Potwierdź mianowanie</span>
			</button>
		</form>
	<% } %>

	<% if($.user.hasPermission($.targetJednostka.PERMISSIONS.DELETE)) { %>
		<h3>Usuwanie</h3>
		<button id="delete-jednostka-button" class="dangerous" api="jednostka/[jednostkaID]/delete">
			<i>delete</i>
			<span>Usuń jednostkę</span>
		</button>
		<dialog id="delete-jednostka-dialog">
			<h1>Trwale usunąć <%= $.targetJednostka.displayName %>?</h1>
			<p>Jednostka i wszystkie związane z nią dane zostaną trwale usunięte. Podjednostki i użytkownicy zostaną przeniesieni do <%= $.targetJednostka.upperJednostki[0]?.displayName || "jednostki nadrzędnej" %>.</p>
			<div class="button-row">
				<button>
					<i>arrow_back</i>
					<span>Anuluj</span>
				</button>
				<button class="dangerous" command>
					<i>delete</i>
					<span>Usuń</span>
				</button>
			</div>
		</dialog>
	<% } %>
<% } %>

<% if($.targetJednostka.subJednostki?.length > 0 || $.user.hasPermission($.targetJednostka.PERMISSIONS.MODIFY) && $.targetJednostka.type > 0) { %>
	<hr>
	<h2>Jednostki</h2>
	<div id="sub-jednostka-list" class="unit-grid">
		<% for(const subJednostka of $.targetJednostka.subJednostki || []) { %>
			<% if(!subJednostka) { %>
				<div>(nieznana jednostka)</div>
			<% } else { %>
				<a href="/jednostki/<%= subJednostka.id %>">
					<h3><%= subJednostka.displayName %></h3>
					<p><%= subJednostka.typeName %></p>
				</a>
			<% } %>
		<% } %>
	</div>
	<% if($.user.hasPermission($.targetJednostka.PERMISSIONS.MODIFY) && $.targetJednostka.type > 0) { %>
		<button id="create-sub-jednostka-button" api="jednostka/[jednostkaID]/subJednostka/create">
			<i>add</i>
			<span>Dodaj jednostkę</span>
		</button>
	<% } %>
<% } %>



<% if($.targetJednostka.funkcje?.length > 0 || $.user.hasPermission($.targetJednostka.PERMISSIONS.MODIFY)) { %>
	<hr>
	<h2>Użytkownicy</h2>
	<div id="jednostka-member-list" class="unit-grid">
		<% for(const funkcja of $.targetJednostka.funkcje || []) { %>
			<a href="/users/<%= funkcja.user.id %>">
				<h3><%= funkcja.user.displayName %></h3>
				<p><%= Text.capitalise(funkcja.displayName) %></p>
			</a>
		<% } %>
	</div>
	<% if($.user.hasPermission($.targetJednostka.PERMISSIONS.MODIFY)) { %>
		<button id="create-user-button" api="jednostka/[jednostkaID]/member/create">
			<i>person_add</i>
			<span>Dodaj użytkownika</span>
		</button>
	<% } %>
<% } %>

<% if($.targetJednostka.wyjazdInvites?.length > 0 && $.user.hasPermission($.targetJednostka.PERMISSIONS.MODIFY)) { %>
	<hr>
	<h2>Wyjazdy</h2>
	<div id="jednostka-wyjazd-list" class="unit-grid">
		<% for(const wyjazd of $.targetJednostka.wyjazdInvites || []) { %>
			<div href="/wyjazdy/<%= wyjazd.id %>">
				<h3><%= wyjazd.displayName %></h3>
				<% if(wyjazd.dates.start && wyjazd.dates.end) { %>
					<p><%= datetime.format(wyjazd.dates.start, "dd-MM-yyyy") %> do <%= datetime.format(wyjazd.dates.end, "dd-MM-yyyy") %></p>
				<% } %>
				<% const invite = wyjazd.invitedJednostki.find(i => i.jednostka == $.targetJednostka.id) %>
				<% if(invite.state == "accepted") { %>
					<div class="button-row">
						<button href="/jednostki/<%= $.targetJednostka.id %>/wyjazdy/<%= wyjazd.id %>/chooseParticipants">
							<i>group_add</i>
							<span>Wybierz uczestników</span>
						</button>
					</div>
				<% } else if(invite.state == "pending") { %>
					<p>Oczekujące zaproszenie...</p>
					<div class="button-row">
						<button api="jednostka/[jednostkaID]/wyjazd/<%= wyjazd.id %>/invitation/accept">
							<i>check</i>
							<span>Zaakceptuj</span>
						</button>
						<button class="dangerous" api="jednostka/[jednostkaID]/wyjazd/<%= wyjazd.id %>/invitation/decline">
							<i>close</i>
							<span>Odrzuć</span>
						</button>
					</div>
				<% } %>
			</div>
		<% } %>
	</div>
<% } %>